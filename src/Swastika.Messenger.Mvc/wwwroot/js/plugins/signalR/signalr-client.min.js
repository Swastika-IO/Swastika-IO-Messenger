(function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,b.signalR=a()}})(function(){return function b(c,d,e){function a(h,i){if(!d[h]){if(!c[h]){var j="function"==typeof require&&require;if(!i&&j)return j(h,!0);if(g)return g(h,!0);var k=new Error("Cannot find module '"+h+"'");throw k.code="MODULE_NOT_FOUND",k}var f=d[h]={exports:{}};c[h][0].call(f.exports,function(b){var d=c[h][1][b];return a(d?d:b)},f,f.exports,b,c,d,e)}return d[h].exports}for(var g="function"==typeof require&&require,f=0;f<e.length;f++)a(e[f]);return a}({1:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});class d{constructor(){this.isAborted=!1}abort(){this.isAborted||(this.isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this.isAborted}}c.AbortController=d},{}],2:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.Base64EncodedHubProtocol=class{constructor(a){this.wrappedProtocol=a,this.name=this.wrappedProtocol.name,this.type=1}parseMessages(a){let b=a.indexOf(":");if(-1==b||";"!=a[a.length-1])throw new Error("Invalid payload.");let c=a.substring(0,b);if(!/^[0-9]+$/.test(c))throw new Error(`Invalid length: '${c}'`);let d=parseInt(c,10);if(d!=a.length-b-2)throw new Error("Invalid message size.");let e=a.substring(b+1,a.length-1),f=atob(e),g=new Uint8Array(f.length);for(let b=0;b<g.length;b++)g[b]=f.charCodeAt(b);return this.wrappedProtocol.parseMessages(g.buffer)}writeMessage(a){let b=new Uint8Array(this.wrappedProtocol.writeMessage(a)),c="";for(let d=0;d<b.byteLength;d++)c+=String.fromCharCode(b[d]);let d=btoa(c);return`${d.length.toString()}:${d};`}}},{}],3:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});class d extends Error{constructor(a,b){super(a),this.statusCode=b}}c.HttpError=d;class e extends Error{constructor(a="A timeout occurred."){super(a)}}c.TimeoutError=e},{}],4:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d;(function(a){const b="\x1E";a.write=function(a){return`${a}${b}`},a.parse=function(a){if(a[a.length-1]!=b)throw new Error("Message is incomplete.");let c=a.split(b);return c.pop(),c}})(d=c.TextMessageFormat||(c.TextMessageFormat={}));var e;(function(a){a.write=function(a){let b=a.byteLength||a.length,c=[];do{let a=127&b;b>>=7,0<b&&(a|=128),c.push(a)}while(0<b);b=a.byteLength||a.length;let d=new Uint8Array(c.length+b);return d.set(c,0),d.set(a,c.length),d.buffer},a.parse=function(a){let b=[],c=new Uint8Array(a);const d=5,e=[0,7,14,21,28];for(let f=0;f<a.byteLength;){let g,h=0,i=0;do g=c[f+h],i|=(127&g)<<e[h],h++;while(h<Math.min(d,a.byteLength-f)&&0!=(128&g));if(0!=(128&g)&&h<d)throw new Error("Cannot read message size.");if(h==d&&7<g)throw new Error("Messages bigger than 2GB are not supported.");if(c.byteLength>=f+h+i)b.push(c.slice?c.slice(f+h,f+h+i):c.subarray(f+h,f+h+i));else throw new Error("Incomplete message.");f=f+h+i}return b}})(e=c.BinaryMessageFormat||(c.BinaryMessageFormat={}))},{}],5:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});const d=a("./Errors");class e{constructor(a,b,c){this.statusCode=a,this.statusText=b,this.content=c}}c.HttpResponse=e;class f{get(a,b){return this.send(Object.assign({},b,{method:"GET",url:a}))}post(a,b){return this.send(Object.assign({},b,{method:"POST",url:a}))}}c.HttpClient=f;c.DefaultHttpClient=class extends f{send(a){return new Promise((b,c)=>{let f=new XMLHttpRequest;f.open(a.method,a.url,!0),f.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.headers&&a.headers.forEach((a,b)=>f.setRequestHeader(b,a)),a.responseType&&(f.responseType=a.responseType),a.abortSignal&&(a.abortSignal.onabort=()=>{f.abort()}),a.timeout&&(f.timeout=a.timeout),f.onload=()=>{a.abortSignal&&(a.abortSignal.onabort=null),200<=f.status&&300>f.status?b(new e(f.status,f.statusText,f.response||f.responseText)):c(new d.HttpError(f.statusText,f.status))},f.onerror=()=>{c(new d.HttpError(f.statusText,f.status))},f.ontimeout=()=>{c(new d.TimeoutError)},f.send(a.content||"")})}}},{"./Errors":3}],6:[function(a,b,c){"use strict";var d=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};Object.defineProperty(c,"__esModule",{value:!0});const e=a("./Transports"),f=a("./HttpClient"),g=a("./ILogger"),h=a("./Loggers");c.HttpConnection=class{constructor(a,b={}){this.features={},this.logger=h.LoggerFactory.createLogger(b.logger),this.baseUrl=this.resolveUrl(a),b=b||{},this.httpClient=b.httpClient||new f.DefaultHttpClient,this.connectionState=2,this.options=b}start(){return d(this,void 0,void 0,function*(){return 2===this.connectionState?(this.connectionState=0,this.startPromise=this.startInternal(),this.startPromise):Promise.reject(new Error("Cannot start a connection that is not in the 'Disconnected' state."))})}startInternal(){return d(this,void 0,void 0,function*(){try{if(this.options.transport===e.TransportType.WebSockets)this.url=this.baseUrl,this.transport=this.createTransport(this.options.transport,[e.TransportType[e.TransportType.WebSockets]]);else{let a;this.options.accessToken&&(a=new Map,a.set("Authorization",`Bearer ${this.options.accessToken()}`));let b=yield this.httpClient.post(this.resolveNegotiateUrl(this.baseUrl),{content:"",headers:a}),c=JSON.parse(b.content);if(this.connectionId=c.connectionId,2==this.connectionState)return;this.connectionId&&(this.url=this.baseUrl+(-1===this.baseUrl.indexOf("?")?"?":"&")+`id=${this.connectionId}`,this.transport=this.createTransport(this.options.transport,c.availableTransports))}this.transport.onreceive=this.onreceive,this.transport.onclose=(a)=>this.stopConnection(!0,a);let a=2===this.features.transferMode?2:1;this.features.transferMode=yield this.transport.connect(this.url,a,this),this.changeState(0,1)}catch(a){throw this.logger.log(g.LogLevel.Error,"Failed to start the connection. "+a),this.connectionState=2,this.transport=null,a}})}createTransport(a,b){if((null===a||void 0===a)&&0<b.length&&(a=e.TransportType[b[0]]),a===e.TransportType.WebSockets&&0<=b.indexOf(e.TransportType[a]))return new e.WebSocketTransport(this.options.accessToken,this.logger);if(a===e.TransportType.ServerSentEvents&&0<=b.indexOf(e.TransportType[a]))return new e.ServerSentEventsTransport(this.httpClient,this.options.accessToken,this.logger);if(a===e.TransportType.LongPolling&&0<=b.indexOf(e.TransportType[a]))return new e.LongPollingTransport(this.httpClient,this.options.accessToken,this.logger);if(this.isITransport(a))return a;throw new Error("No available transports found.")}isITransport(a){return"object"==typeof a&&"connect"in a}changeState(a,b){return!(this.connectionState!=a)&&(this.connectionState=b,!0)}send(a){if(1!=this.connectionState)throw new Error("Cannot send data if the connection is not in the 'Connected' State");return this.transport.send(a)}stop(a){return d(this,void 0,void 0,function*(){let b=this.connectionState;this.connectionState=2;try{yield this.startPromise}catch(a){}this.stopConnection(1==b,a)})}stopConnection(a,b){this.transport&&(this.transport.stop(),this.transport=null),this.connectionState=2,a&&this.onclose&&this.onclose(b)}resolveUrl(a){if(0===a.lastIndexOf("https://",0)||0===a.lastIndexOf("http://",0))return a;if("undefined"==typeof window||!window||!window.document)throw new Error(`Cannot resolve '${a}'.`);let b=window.document.createElement("a");b.href=a;let c=b.protocol&&":"!==b.protocol?`${b.protocol}//${b.host}`:`${window.document.location.protocol}//${b.host||window.document.location.host}`;a&&"/"==a[0]||(a="/"+a);let d=c+a;return this.logger.log(g.LogLevel.Information,`Normalizing '${a}' to '${d}'`),d}resolveNegotiateUrl(a){let b=a.indexOf("?"),c=a.substring(0,-1===b?a.length:b);return"/"!==c[c.length-1]&&(c+="/"),c+="negotiate",c+=-1===b?"":a.substring(b),c}}},{"./HttpClient":5,"./ILogger":8,"./Loggers":10,"./Transports":12}],7:[function(a,b,c){"use strict";var d=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};Object.defineProperty(c,"__esModule",{value:!0});const e=a("./HttpConnection"),f=a("./Observable"),g=a("./JsonHubProtocol"),h=a("./Formatters"),i=a("./Base64EncodedHubProtocol"),j=a("./ILogger"),k=a("./Loggers");var l=a("./Transports");c.TransportType=l.TransportType;var m=a("./HttpConnection");c.HttpConnection=m.HttpConnection;var n=a("./JsonHubProtocol");c.JsonHubProtocol=n.JsonHubProtocol;var o=a("./ILogger");c.LogLevel=o.LogLevel;var p=a("./Loggers");c.ConsoleLogger=p.ConsoleLogger,c.NullLogger=p.NullLogger;c.HubConnection=class{constructor(a,b={}){b=b||{},this.timeoutInMilliseconds=b.timeoutInMilliseconds||30000,this.connection="string"==typeof a?new e.HttpConnection(a,b):a,this.logger=k.LoggerFactory.createLogger(b.logger),this.protocol=b.protocol||new g.JsonHubProtocol,this.connection.onreceive=(a)=>this.processIncomingData(a),this.connection.onclose=(a)=>this.connectionClosed(a),this.callbacks=new Map,this.methods=new Map,this.closedCallbacks=[],this.id=0}processIncomingData(a){this.timeoutHandle!==void 0&&clearTimeout(this.timeoutHandle);let b=this.protocol.parseMessages(a);for(var c,d=0;d<b.length;++d)switch(c=b[d],c.type){case 1:this.invokeClientMethod(c);break;case 2:case 3:let e=this.callbacks.get(c.invocationId);null!=e&&(3===c.type&&this.callbacks.delete(c.invocationId),e(c));break;case 6:break;default:this.logger.log(j.LogLevel.Warning,"Invalid message type: "+a);}this.configureTimeout()}configureTimeout(){this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout(()=>this.serverTimeout(),this.timeoutInMilliseconds))}serverTimeout(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))}invokeClientMethod(a){let b=this.methods.get(a.target.toLowerCase());if(!b)this.logger.log(j.LogLevel.Warning,`No client method with the name '${a.target}' found.`);else if(b.forEach((b)=>b.apply(this,a.arguments)),a.invocationId){let a="Server requested a response, which is not supported in this version of the client.";this.logger.log(j.LogLevel.Error,a),this.connection.stop(new Error(a))}}connectionClosed(a){this.callbacks.forEach((b)=>{b(void 0,a?a:new Error("Invocation canceled due to connection being closed."))}),this.callbacks.clear(),this.closedCallbacks.forEach((b)=>b.apply(this,[a]))}start(){return d(this,void 0,void 0,function*(){let a=2===this.protocol.type?2:1;this.connection.features.transferMode=a,yield this.connection.start();var b=this.connection.features.transferMode;yield this.connection.send(h.TextMessageFormat.write(JSON.stringify({protocol:this.protocol.name}))),this.logger.log(j.LogLevel.Information,`Using HubProtocol '${this.protocol.name}'.`),2==a&&1===b&&(this.protocol=new i.Base64EncodedHubProtocol(this.protocol)),this.configureTimeout()})}stop(){return this.timeoutHandle&&clearTimeout(this.timeoutHandle),this.connection.stop()}stream(a,...b){let c=this.createStreamInvocation(a,b),d=new f.Subject(()=>{let a=this.createCancelInvocation(c.invocationId),b=this.protocol.writeMessage(a);return this.callbacks.delete(c.invocationId),this.connection.send(b)});this.callbacks.set(c.invocationId,(a,b)=>{if(b)return void d.error(b);if(3===a.type){let b=a;b.error?d.error(new Error(b.error)):d.complete()}else d.next(a.item)});let e=this.protocol.writeMessage(c);return this.connection.send(e).catch((a)=>{d.error(a),this.callbacks.delete(c.invocationId)}),d}send(a,...b){let c=this.createInvocation(a,b,!0),d=this.protocol.writeMessage(c);return this.connection.send(d)}invoke(a,...b){let c=this.createInvocation(a,b,!1),d=new Promise((a,b)=>{this.callbacks.set(c.invocationId,(c,d)=>{if(d)return void b(d);if(3===c.type){let d=c;d.error?b(new Error(d.error)):a(d.result)}else b(new Error(`Unexpected message type: ${c.type}`))});let d=this.protocol.writeMessage(c);this.connection.send(d).catch((a)=>{b(a),this.callbacks.delete(c.invocationId)})});return d}on(a,b){a&&b&&(a=a.toLowerCase(),!this.methods.has(a)&&this.methods.set(a,[]),this.methods.get(a).push(b))}off(a,b){if(a&&b){a=a.toLowerCase();let d=this.methods.get(a);if(d){var c=d.indexOf(b);-1!=c&&d.splice(c,1)}}}onclose(a){a&&this.closedCallbacks.push(a)}createInvocation(a,b,c){if(c)return{type:1,target:a,arguments:b};else{let c=this.id;return this.id++,{type:1,invocationId:c.toString(),target:a,arguments:b}}}createStreamInvocation(a,b){let c=this.id;return this.id++,{type:4,invocationId:c.toString(),target:a,arguments:b}}createCancelInvocation(a){return{type:5,invocationId:a}}}},{"./Base64EncodedHubProtocol":2,"./Formatters":4,"./HttpConnection":6,"./ILogger":8,"./JsonHubProtocol":9,"./Loggers":10,"./Observable":11,"./Transports":12}],8:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d;(function(a){a[a.Trace=0]="Trace",a[a.Information=1]="Information",a[a.Warning=2]="Warning",a[a.Error=3]="Error",a[a.None=4]="None"})(d=c.LogLevel||(c.LogLevel={}))},{}],9:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});const d=a("./Formatters");c.JsonHubProtocol=class{constructor(){this.name="json",this.type=1}parseMessages(a){if(!a)return[];let b=d.TextMessageFormat.parse(a),c=[];for(var e=0;e<b.length;++e)c.push(JSON.parse(b[e]));return c}writeMessage(a){return d.TextMessageFormat.write(JSON.stringify(a))}}},{"./Formatters":4}],10:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});const d=a("./ILogger");class e{log(){}}c.NullLogger=e;class f{constructor(a){this.minimumLogLevel=a}log(a,b){a>=this.minimumLogLevel&&(a===d.LogLevel.Error?console.error(`${d.LogLevel[a]}: ${b}`):a===d.LogLevel.Warning?console.warn(`${d.LogLevel[a]}: ${b}`):a===d.LogLevel.Information?console.info(`${d.LogLevel[a]}: ${b}`):console.log(`${d.LogLevel[a]}: ${b}`))}}c.ConsoleLogger=f;var g;(function(a){a.createLogger=function(a){return void 0===a?new f(d.LogLevel.Information):null===a?new e:a.log?a:new f(a)}})(g=c.LoggerFactory||(c.LoggerFactory={}))},{"./ILogger":8}],11:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});class d{constructor(a,b){this.subject=a,this.observer=b}dispose(){let a=this.subject.observers.indexOf(this.observer);-1<a&&this.subject.observers.splice(a,1),0===this.subject.observers.length&&this.subject.cancelCallback().catch(()=>{})}}c.Subscription=d;c.Subject=class{constructor(a){this.observers=[],this.cancelCallback=a}next(a){for(let b of this.observers)b.next(a)}error(a){for(let b of this.observers)b.error&&b.error(a)}complete(){for(let a of this.observers)a.complete&&a.complete()}subscribe(a){return this.observers.push(a),new d(this,a)}}},{}],12:[function(a,b,c){"use strict";function d(a,b,c,d){return e(this,void 0,void 0,function*(){let e;c&&(e=new Map,e.set("Authorization",`Bearer ${c()}`)),yield a.post(b,{content:d,headers:e})})}var e=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};Object.defineProperty(c,"__esModule",{value:!0});const f=a("./Errors"),g=a("./ILogger"),h=a("./AbortController");var i;(function(a){a[a.WebSockets=0]="WebSockets",a[a.ServerSentEvents=1]="ServerSentEvents",a[a.LongPolling=2]="LongPolling"})(i=c.TransportType||(c.TransportType={}));c.WebSocketTransport=class{constructor(a,b){this.logger=b,this.accessToken=a}connect(a,b){return new Promise((c,d)=>{if(a=a.replace(/^http/,"ws"),this.accessToken){let b=this.accessToken();a+=(0>a.indexOf("?")?"?":"&")+`signalRTokenHeader=${b}`}let e=new WebSocket(a);2==b&&(e.binaryType="arraybuffer"),e.onopen=()=>{this.logger.log(g.LogLevel.Information,`WebSocket connected to ${a}`),this.webSocket=e,c(b)},e.onerror=()=>{d()},e.onmessage=(a)=>{this.logger.log(g.LogLevel.Trace,`(WebSockets transport) data received: ${a.data}`),this.onreceive&&this.onreceive(a.data)},e.onclose=(a)=>{this.onclose&&this.webSocket&&(!1===a.wasClean||1e3!==a.code?this.onclose(new Error(`Websocket closed with status code: ${a.code} (${a.reason})`)):this.onclose())}})}send(a){return this.webSocket&&this.webSocket.readyState===WebSocket.OPEN?(this.webSocket.send(a),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this.webSocket&&(this.webSocket.close(),this.webSocket=null),Promise.resolve()}};c.ServerSentEventsTransport=class{constructor(a,b,c){this.httpClient=a,this.accessToken=b,this.logger=c}connect(a){return"undefined"==typeof EventSource&&Promise.reject("EventSource not supported by the browser."),this.url=a,new Promise((b,c)=>{if(this.accessToken){let b=this.accessToken();a+=(0>a.indexOf("?")?"?":"&")+`signalRTokenHeader=${b}`}let d=new EventSource(a);try{d.onmessage=(a)=>{if(this.onreceive)try{this.logger.log(g.LogLevel.Trace,`(SSE transport) data received: ${a.data}`),this.onreceive(a.data)}catch(a){return void(this.onclose&&this.onclose(a))}},d.onerror=(a)=>{c(),this.eventSource&&this.onclose&&this.onclose(new Error(a.message||"Error occurred"))},d.onopen=()=>{this.logger.log(g.LogLevel.Information,`SSE connected to ${this.url}`),this.eventSource=d,b(1)}}catch(a){return Promise.reject(a)}})}send(a){return e(this,void 0,void 0,function*(){return d(this.httpClient,this.url,this.accessToken,a)})}stop(){return this.eventSource&&(this.eventSource.close(),this.eventSource=null),Promise.resolve()}};c.LongPollingTransport=class{constructor(a,b,c){this.httpClient=a,this.accessToken=b,this.logger=c,this.pollAbort=new h.AbortController}connect(a,b,c){if(this.url=a,c.features.inherentKeepAlive=!0,2===b&&"string"!=typeof new XMLHttpRequest().responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");return this.poll(this.url,b),Promise.resolve(b)}poll(a,b){return e(this,void 0,void 0,function*(){let c={timeout:1.2e5,abortSignal:this.pollAbort.signal,headers:new Map};for(2===b&&(c.responseType="arraybuffer"),this.accessToken&&c.headers.set("Authorization",`Bearer ${this.accessToken()}`);!this.pollAbort.signal.aborted;)try{let b=`${a}&_=${Date.now()}`;this.logger.log(g.LogLevel.Trace,`(LongPolling transport) polling: ${b}`);let d=yield this.httpClient.get(b,c);204===d.statusCode?(this.logger.log(g.LogLevel.Information,"(LongPolling transport) Poll terminated by server"),this.onclose&&this.onclose(),this.pollAbort.abort()):200===d.statusCode?d.content?(this.logger.log(g.LogLevel.Trace,`(LongPolling transport) data received: ${d.content}`),this.onreceive&&this.onreceive(d.content)):this.logger.log(g.LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this.logger.log(g.LogLevel.Error,`(LongPolling transport) Unexpected response code: ${d.statusCode}`),this.onclose&&this.onclose(new f.HttpError(d.statusText,d.statusCode)),this.pollAbort.abort())}catch(a){a instanceof f.TimeoutError?this.logger.log(g.LogLevel.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this.onclose&&this.onclose(a),this.pollAbort.abort())}})}send(a){return e(this,void 0,void 0,function*(){return d(this.httpClient,this.url,this.accessToken,a)})}stop(){return this.pollAbort.abort(),Promise.resolve()}}},{"./AbortController":1,"./Errors":3,"./ILogger":8}]},{},[7])(7)});